<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç‰©å“ç®¡ç†é¢æ¿</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: #f8f9fa;
      padding: 20px;
    }
    .panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .form-label {
      font-weight: bold;
    }
    table img {
      width: 24px;
      vertical-align: middle;
      margin-right: 5px;
    }
    .status-lost { color: #d63031; }
    .status-found { color: #00b894; }
  </style>
</head>
<body>

<div class="container panel">
  <h1>ğŸ’ ç‰©å“ç®¡ç†é¢æ¿</h1>

  <div class="mb-4">
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">GitHub Personal Access Token (PAT)</label>
        <input type="text" class="form-control" id="tokenInput" placeholder="è¾“å…¥ä½ çš„ GitHub Tokenï¼ˆä¸ä¼šä¿å­˜ï¼‰" />
      </div>
      <div class="col-md-4">
        <label class="form-label">ä»“åº“ä¿¡æ¯</label>
        <input type="text" class="form-control" id="repoInput" placeholder="ç”¨æˆ·å/ä»“åº“å" value="your-username/your-repo" />
      </div>
      <div class="col-12">
        <button class="btn btn-primary" onclick="saveToken()">ä¿å­˜é…ç½®</button>
        <small class="text-muted">Token ä»…ä¿å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­</small>
      </div>
    </div>
  </div>

  <hr />

  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>ç‰©å“åç§°</th>
          <th>å§“å</th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="itemList"></tbody>
    </table>
  </div>

  <button class="btn btn-success" onclick="addNewItem()">+ æ·»åŠ æ–°ç‰©å“</button>
  <button class="btn btn-outline-primary float-end" onclick="uploadToJson()">ğŸ“¤ ä¿å­˜å¹¶ä¸Šä¼ åˆ° GitHub</button>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¼–è¾‘ç‰©å“</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editId" />
          <div class="mb-3">
            <label class="form-label">ID</label>
            <input type="text" class="form-control" id="editIdField" readonly />
          </div>
          <div class="mb-3">
            <label class="form-label">ç‰©å“åç§°</label>
            <input type="text" class="form-control" id="editItem" required />
          </div>
          <div class="mb-3">
            <label class="form-label">å§“å</label>
            <input type="text" class="form-control" id="editName" />
          </div>
          <div class="mb-3">
            <label class="form-label">ç­çº§</label>
            <input type="text" class="form-control" id="editClass" />
          </div>
          <div class="mb-3">
            <label class="form-label">ç”µè¯</label>
            <input type="text" class="form-control" id="editPhone" />
          </div>
          <div class="mb-3">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-control" id="editStatus">
              <option value="0">æœªä¸¢å¤±</option>
              <option value="1">å·²ä¸¢å¤±</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ç•™è¨€</label>
            <textarea class="form-control" id="editMessage"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // æ•°æ®
  let items = [];
  let token = '';
  let repo = 'your-username/your-repo'; // é»˜è®¤ä»“åº“

  // ä¿å­˜ Token å’Œ Repo
  function saveToken() {
    token = document.getElementById('tokenInput').value.trim();
    repo = document.getElementById('repoInput').value.trim();
    if (!token) return alert('è¯·è¾“å…¥ GitHub Token');
    if (!repo) return alert('è¯·è¾“å…¥ä»“åº“åï¼Œå¦‚ï¼šoctocat/MyRepo');
    alert('é…ç½®å·²ä¿å­˜ï¼');
  }

  // åŠ è½½ state.json
  async function loadItems() {
    try {
      const res = await fetch('https://cdn.jsdelivr.net/gh/' + repo + '/state.json?r=' + Math.random());
      items = await res.json();
      renderList();
    } catch (e) {
      alert('åŠ è½½æ•°æ®å¤±è´¥ï¼š' + e.message);
      console.error(e);
    }
  }

  // æ¸²æŸ“åˆ—è¡¨
  function renderList() {
    const tbody = document.getElementById('itemList');
    tbody.innerHTML = items.map(item => {
      const statusText = item.status == 1 
        ? '<span class="status-lost">âš ï¸ å·²ä¸¢å¤±</span>' 
        : '<span class="status-found">âœ… æœªä¸¢å¤±</span>';
      return `
        <tr>
          <td>${item.id}</td>
          <td>${item.item || '-'}</td>
          <td>${item.name || '-'}</td>
          <td>${statusText}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editItem('${item.id}')">ç¼–è¾‘</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ç¼–è¾‘ç‰©å“
  function editItem(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;

    document.getElementById('editId').value = item.id;
    document.getElementById('editIdField').value = item.id;
    document.getElementById('editItem').value = item.item || '';
    document.getElementById('editName').value = item.name || '';
    document.getElementById('editClass').value = item.class || '';
    document.getElementById('editPhone').value = item.phone || '';
    document.getElementById('editStatus').value = item.status || 0;
    document.getElementById('editMessage').value = item.message || '';

    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
  }

  // ä¿å­˜ç¼–è¾‘
  function saveEdit() {
    const id = document.getElementById('editId').value;
    const item = items.find(i => i.id === id);
    if (!item) return;

    item.item = document.getElementById('editItem').value;
    item.name = document.getElementById('editName').value;
    item.class = document.getElementById('editClass').value;
    item.phone = document.getElementById('editPhone').value;
    item.status = Number(document.getElementById('editStatus').value);
    item.message = document.getElementById('editMessage').value;

    document.getElementById('editModal').querySelector('.btn-close').click();
    renderList();
  }

  // æ·»åŠ æ–°ç‰©å“
  function addNewItem() {
    const id = prompt('è¯·è¾“å…¥æ–°ç‰©å“çš„ IDï¼ˆå¦‚ 0002ï¼‰');
    if (!id || items.some(i => i.id === id)) {
      return alert('ID å·²å­˜åœ¨æˆ–æ— æ•ˆ');
    }
    const newItem = {
      id,
      status: 0,
      item: 'æ–°ç‰©å“',
      name: '',
      phone: '',
      class: '',
      address: '',
      qq: '',
      wechat: '',
      email: '',
      date: '',
      message: ''
    };
    items.push(newItem);
    renderList();
    editItem(id); // è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘
  }

  // ä¸Šä¼ åˆ° GitHub
  async function uploadToJson() {
    if (!token) return alert('è¯·å…ˆè¾“å…¥ GitHub Token');
    if (!repo) return alert('è¯·å¡«å†™ä»“åº“å');

    const owner = repo.split('/')[0];
    const repoName = repo.split('/')[1];
    if (!owner || !repoName) return alert('ä»“åº“æ ¼å¼é”™è¯¯ï¼šåº”ä¸º ç”¨æˆ·å/ä»“åº“å');

    try {
      const path = 'state.json';

      // å…ˆè·å–å½“å‰æ–‡ä»¶çš„ shaï¼ˆç”¨äºæ›´æ–°ï¼‰
      const headRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      const headData = await headRes.json();
      const sha = headData.sha;

      // æ„é€ æäº¤å†…å®¹
      const content = JSON.stringify(items, null, 2);
      const encoded = btoa(unescape(encodeURIComponent(content)));

      const payload = {
        message: `ğŸ“ æ›´æ–° state.json via ç®¡ç†é¢æ¿ - ${new Date().toLocaleString()}`,
        content: encoded,
        sha,
        branch: "main"
      };

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (res.ok) {
        alert('âœ… æˆåŠŸä¸Šä¼ åˆ° GitHubï¼');
      } else {
        alert('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + (result.message || JSON.stringify(result)));
        console.error(result);
      }
    } catch (e) {
      alert('âŒ é”™è¯¯ï¼š' + e.message);
      console.error(e);
    }
  }

  // åˆå§‹åŒ–
  window.onload = function () {
    loadItems();
  };
</script>

</body>
</html>