<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>物品管理面板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: #f8f9fa;
      padding: 20px;
    }
    .panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .form-label {
      font-weight: bold;
    }
    table img {
      width: 24px;
      vertical-align: middle;
      margin-right: 5px;
    }
    .status-lost { color: #d63031; }
    .status-found { color: #00b894; }
  </style>
</head>
<body>

<div class="container panel">
  <h1>🎒 物品管理面板</h1>

  <div class="mb-4">
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">GitHub Personal Access Token (PAT)</label>
        <input type="text" class="form-control" id="tokenInput" placeholder="输入你的 GitHub Token（不会保存）" />
      </div>
      <div class="col-md-4">
        <label class="form-label">仓库信息</label>
        <input type="text" class="form-control" id="repoInput" placeholder="用户名/仓库名" value="your-username/your-repo" />
      </div>
      <div class="col-12">
        <button class="btn btn-primary" onclick="saveToken()">保存配置</button>
        <small class="text-muted">Token 仅保存在本地内存中</small>
      </div>
    </div>
  </div>

  <hr />

  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>物品名称</th>
          <th>姓名</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="itemList"></tbody>
    </table>
  </div>

  <button class="btn btn-success" onclick="addNewItem()">+ 添加新物品</button>
  <button class="btn btn-outline-primary float-end" onclick="uploadToJson()">📤 保存并上传到 GitHub</button>
</div>

<!-- 编辑模态框 -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">编辑物品</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editId" />
          <div class="mb-3">
            <label class="form-label">ID</label>
            <input type="text" class="form-control" id="editIdField" readonly />
          </div>
          <div class="mb-3">
            <label class="form-label">物品名称</label>
            <input type="text" class="form-control" id="editItem" required />
          </div>
          <div class="mb-3">
            <label class="form-label">姓名</label>
            <input type="text" class="form-control" id="editName" />
          </div>
          <div class="mb-3">
            <label class="form-label">班级</label>
            <input type="text" class="form-control" id="editClass" />
          </div>
          <div class="mb-3">
            <label class="form-label">电话</label>
            <input type="text" class="form-control" id="editPhone" />
          </div>
          <div class="mb-3">
            <label class="form-label">状态</label>
            <select class="form-control" id="editStatus">
              <option value="0">未丢失</option>
              <option value="1">已丢失</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">留言</label>
            <textarea class="form-control" id="editMessage"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 数据
  let items = [];
  let token = '';
  let repo = 'your-username/your-repo'; // 默认仓库

  // 保存 Token 和 Repo
  function saveToken() {
    token = document.getElementById('tokenInput').value.trim();
    repo = document.getElementById('repoInput').value.trim();
    if (!token) return alert('请输入 GitHub Token');
    if (!repo) return alert('请输入仓库名，如：octocat/MyRepo');
    alert('配置已保存！');
  }

  // 加载 state.json
  async function loadItems() {
    try {
      const res = await fetch('https://cdn.jsdelivr.net/gh/' + repo + '/state.json?r=' + Math.random());
      items = await res.json();
      renderList();
    } catch (e) {
      alert('加载数据失败：' + e.message);
      console.error(e);
    }
  }

  // 渲染列表
  function renderList() {
    const tbody = document.getElementById('itemList');
    tbody.innerHTML = items.map(item => {
      const statusText = item.status == 1 
        ? '<span class="status-lost">⚠️ 已丢失</span>' 
        : '<span class="status-found">✅ 未丢失</span>';
      return `
        <tr>
          <td>${item.id}</td>
          <td>${item.item || '-'}</td>
          <td>${item.name || '-'}</td>
          <td>${statusText}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editItem('${item.id}')">编辑</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // 编辑物品
  function editItem(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;

    document.getElementById('editId').value = item.id;
    document.getElementById('editIdField').value = item.id;
    document.getElementById('editItem').value = item.item || '';
    document.getElementById('editName').value = item.name || '';
    document.getElementById('editClass').value = item.class || '';
    document.getElementById('editPhone').value = item.phone || '';
    document.getElementById('editStatus').value = item.status || 0;
    document.getElementById('editMessage').value = item.message || '';

    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
  }

  // 保存编辑
  function saveEdit() {
    const id = document.getElementById('editId').value;
    const item = items.find(i => i.id === id);
    if (!item) return;

    item.item = document.getElementById('editItem').value;
    item.name = document.getElementById('editName').value;
    item.class = document.getElementById('editClass').value;
    item.phone = document.getElementById('editPhone').value;
    item.status = Number(document.getElementById('editStatus').value);
    item.message = document.getElementById('editMessage').value;

    document.getElementById('editModal').querySelector('.btn-close').click();
    renderList();
  }

  // 添加新物品
  function addNewItem() {
    const id = prompt('请输入新物品的 ID（如 0002）');
    if (!id || items.some(i => i.id === id)) {
      return alert('ID 已存在或无效');
    }
    const newItem = {
      id,
      status: 0,
      item: '新物品',
      name: '',
      phone: '',
      class: '',
      address: '',
      qq: '',
      wechat: '',
      email: '',
      date: '',
      message: ''
    };
    items.push(newItem);
    renderList();
    editItem(id); // 自动打开编辑
  }

  // 上传到 GitHub
  async function uploadToJson() {
    if (!token) return alert('请先输入 GitHub Token');
    if (!repo) return alert('请填写仓库名');

    const owner = repo.split('/')[0];
    const repoName = repo.split('/')[1];
    if (!owner || !repoName) return alert('仓库格式错误：应为 用户名/仓库名');

    try {
      const path = 'state.json';

      // 先获取当前文件的 sha（用于更新）
      const headRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      const headData = await headRes.json();
      const sha = headData.sha;

      // 构造提交内容
      const content = JSON.stringify(items, null, 2);
      const encoded = btoa(unescape(encodeURIComponent(content)));

      const payload = {
        message: `📝 更新 state.json via 管理面板 - ${new Date().toLocaleString()}`,
        content: encoded,
        sha,
        branch: "main"
      };

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (res.ok) {
        alert('✅ 成功上传到 GitHub！');
      } else {
        alert('❌ 上传失败：' + (result.message || JSON.stringify(result)));
        console.error(result);
      }
    } catch (e) {
      alert('❌ 错误：' + e.message);
      console.error(e);
    }
  }

  // 初始化
  window.onload = function () {
    loadItems();
  };
</script>

</body>
</html>